<script>
// === Helpers ===
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function setRequired(names, on){ names.forEach(n => { const el = document.querySelector(`[name="${n}"]`); if (el) el.required = !!on; }); }
function show(id, on){ const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !on); }

// Category switching
function updateCategory(){
  const v = (new FormData($('#ticketForm')).get('category')) || 'FlowSite Requests';
  show('sec-ost', v === 'On-Site Troubleshooting');
  show('sec-sr',  v === 'Service Request');
  show('sec-fr',  v === 'FlowSite Requests');
  show('sec-scada', v === 'SCADA/Comms');

  // reset required flags
  setRequired([
    'locationName_ost','product_ost','serial_ost','sw_ost',
    'locationName_sr','product_sr','serial_sr','sw_sr','damaged_sr',
    'locationName_fr','product_fr','serial_fr','sw_fr',
    'user_name_fr','user_email_fr','user_company_fr','serials_for_access_fr',
    'locationName_sc','product_sc','serial_sc','sw_sc',
    'other_desc_fr'
  ], false);

  if (v === 'On-Site Troubleshooting') setRequired(['locationName_ost','product_ost','serial_ost'], true);
  if (v === 'Service Request') setRequired(['locationName_sr','product_sr','serial_sr','damaged_sr'], true);
  if (v === 'FlowSite Requests') updateFlowSiteType();
  if (v === 'SCADA/Comms') setRequired(['locationName_sc','product_sc','serial_sc'], true);
}
$$('input[name="category"]').forEach(r=>r.addEventListener('change', updateCategory));

// FlowSite Requests subtype
function updateFlowSiteType(){
  const type = (new FormData($('#ticketForm')).get('frtype')) || 'Add Systems for Existing FlowSite User';
  show('fr-dx', type === 'Diagnostics Assistance');
  show('fr-add', type === 'Add Systems for New FlowSite User' || type === 'Add Systems for Existing FlowSite User');
  show('fr-other', type === 'Other');

  setRequired(['locationName_fr','product_fr','serial_fr','sw_fr','user_name_fr','user_email_fr','user_company_fr','serials_for_access_fr','other_desc_fr'], false);
  if (type === 'Diagnostics Assistance') setRequired(['locationName_fr','product_fr','serial_fr'], true);
  if (type === 'Add Systems for New FlowSite User' || type === 'Add Systems for Existing FlowSite User') setRequired(['user_name_fr','user_email_fr','user_company_fr','serials_for_access_fr'], true);
  if (type === 'Other') setRequired(['other_desc_fr'], true);
}
$$('input[name="frtype"]').forEach(r=>r.addEventListener('change', updateFlowSiteType));

// Init visibility/requireds
updateCategory(); updateFlowSiteType();

// === Submit (REAL function call) ===
const btn = $('#submitBtn');
const modal = document.getElementById('submitModal');
const modalCloseBtn = document.getElementById('modalCloseBtn');

function openModal(){ if(modal){ modal.classList.remove('hidden'); modalCloseBtn && modalCloseBtn.focus(); } }
function closeModal(){ if(modal){ modal.classList.add('hidden'); } }
modal && modal.addEventListener('click', (ev)=>{ if(ev.target===modal) closeModal(); });
modalCloseBtn && modalCloseBtn.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  btn.disabled = true;
  btn.textContent = 'Submitting…';

  try {
    // send the whole form for logging; function will only write TicketID for now
    const formJson = Object.fromEntries(new FormData(e.target).entries());

    const res = await fetch('/.netlify/functions/submit-ticket', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ form: formJson })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status} – ${text}`);
    }

    const data = await res.json();
    // clear form + show confirmation
    e.target.reset();
    updateCategory(); updateFlowSiteType();
    openModal();

  } catch (err) {
    alert(`Submit failed: ${err.message}`);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Request';
  }
});

// Reset button
document.getElementById('resetBtn').addEventListener('click', ()=>{
  const form = document.getElementById('ticketForm');
  form.reset();
  updateCategory(); updateFlowSiteType();
});
</script>
